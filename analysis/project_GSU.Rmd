---
title: "BDA - Project"
author: "Anonymous"
output: 
  pdf_document: 
    toc: yes
    toc_depth: 3
urlcolor: blue
---
```{r setup, include = TRUE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 6, fig.width = 10)
# load libraries
pkgs <- c("tidyr", "ggplot2", "rstan", "bayesplot", "parallel", "loo", 
          "readxl")
sapply(pkgs, require, character.only = TRUE)
# set number of default cores
options(mc.cores = detectCores())
# set plot theme
theme_set(theme_minimal()) 
# set colour scheme
color_scheme_set("blue")
```

**Note: this is the contents page. The assignment starts on the following page.**\
\newpage  

#  1. Introduction
This project is motivated by a thesis I finished in 2020. The thesis included a pairwise random-effects meta-analysis to estimate the efficacy of the Bivalent Human Papillomavirus vaccine. It was originally coded in JAGS, did not have any proper priors, did not include coefficients, and was ultimately used to inform a fully-integrated Bayesian health economics model. The original JAGS model was coded as:


```
# likelihood and prior. Model parameters are abbreviated by .vac.
  for (i in 1:Nstud.vac) {
    # Likelihood:
     rA.vac[i] ~ dbin(pA.vac[i], nA.vac[i])
     rB.vac[i] ~ dbin(pB.vac[i], nB.vac[i])

    # Logistic link function:
     logit(pA.vac[i]) <- mu.vac[i]
     logit(pB.vac[i]) <- mu.vac[i] + delta.vac[i]
    
    # Average random effect prior for SUB-MODEL 2:
     mu.vac[i] ~ dnorm(0, 1e-4)
    # Prior for sub-model 2 (ATE pop. effect):
     delta.vac[i] ~ dt(psi.vac, prec.vac, 1) 
     # if desired can be ~ dnorm(psi.vac, prec.vac)
    
     ### Mixed predictive check for SUB-MODEL 2:
       # Predictive likelihood:
        rA.mxd[i] ~ dbin(pA.new[i], nA.vac[i])
        
       # Predictive logit link function:
        logit(pA.new[i]) <- mu.vac[i] + delta.new
               
       # Mixed predictve p-value:
        pA.mxd[i] <- step(rA.mxd[i] - rA.vac[i]) - 0.5 * equals(rA.mxd[i], rA.vac[i])
```

Since finishing the thesis, I have wanted to redo the meta-analysis in Stan. Note that this project won't, however, include the economic model. Please see a simple illustration of the model below (note that some of the final model assumptions may differ).

<center>
![Model illustration. Note that some parameter distributions for the final are different, since informative priors have been added](misc/model_illustration.png)
<center>

Given the above motivation, I will implement the original model in Stan and include proper priors, which will be given logical boundaries when necessary. Coefficients will also be included where applicable. I will also compare grouped and hierarchical models.

\newpage  
#  2. Data
The data for the model are printed below. Note that references for each input can be found in the original Excel file.
```{r data, include = TRUE}
# load data
df <- read_excel("data/data_vaccine_case_control.xlsx")
# print data frame
DT::datatable(df)
```

We can then prepare the data for Stan as follows:
```{r data prep, include = TRUE}
# n studies
n_s <- nrow(df)
# y events in control arm
y_0 <- df$y_control
# y events in vaccine arm
y_1 <- df$y_vaccine
# n observations in control arm
n_0 <- df$n_control
# n observations in vaccine arm
n_1 <- df$n_vaccine
# data list
data_list <- list(n_s = n_s, y_0 = y_0, n_0 = n_0, y_1 = y_1, n_1 = n_1)
```
The model will thus loop through an $i \times j$ matrix, with $i$ rows and $j$ columns, where there are $i$ studies with $j$ arms.

#  3. Model
The general model is a simple binomial model with several priors and hyperiors (same as above). However, to provide an understanding of whether a separate or hierarchical model is better suited to the problem at hand, we can ought to run the model as both a separate or hierarchical model, respectively. These different approaches to the model have a slightly different structure, which is detailed in the '*Model background and results*' section below.

##  3.1 Model background and results  
Below is a brief discussion and illustration of each model.

###  3.3.1 The Separate model
The separate model is the simpler of the two types (in terms of the number of parameters). Notationally, the model can be represented as 
\[
y_{ij} \sim Bin(n_{ij}, p_{ij})
\]
where $y_{ij}$ and $n_{ij$ are the $i$'th events and observations for $j'th$ arm (vaccine or control), respectively. Then, to define a generalised linear model, we can use a logit link to develop a logistic regression model. Thus,
\[
logit(p_{ij})\equiv log(\frac{p_{ij}}{1 - p{ij}})
\]
which, more precisely, is the linear predictor
\[
logit(p_{ij}) = \mu_{i} + \Delta_{ij}
\]
where
\[
\mu_{i} \sim \mathcal{N}(20, 2)
\]
and
$$
\Delta_{.j}= \begin{cases}
 0, & \text{if } j = 0 (control arm)\\
 \sim St(\nu, \psi, \tau), & \text{if } j = 1 (vaccine arm)\\
\end{cases}
$$
since the control arm is no average treatment effect (ATE). Note that $mu_{i}$ represents the group-level 'random effect'. The probability of efficacy is therefore assumed to be a additive combination of a random population effect and the average treatment effect, at a group-level, when applicable (conditional on whether the group arm received the treatment or not). Here, $\psi$ and $\tau$ represent reasonable informative prior values (which are $84$ and $4$ respectively. However, note that the priors $\mu_{i$ and $\Delta_{ij}$ values for the separate model are recoded as hyperpriors in the hierarchical model. Discussion on these values is therefore deferred to section 3.3.2. Finally, note that the Stan code for the separate model is coded as
```
// Random Effects
// Pair-wise meta-analysis
// Binomial model, logit link
data {
 int <lower = 0> n_s;
 int <lower = 0> y_0[n_s];
 int <lower = 0> n_0[n_s];
 int <lower = 0> y_1[n_s];
 int <lower = 0> n_1[n_s];
}
parameters {
 real mu[n_s];
 real delta[n_s];
}
transformed parameters {
 real p_eff[n_s];
 real odds_eff[n_s];
 for (i in 1:n_s) {
  // anti-logit
  odds_eff[i] = exp(delta[i]);      // transform log-odds ratio to odds-ratio
  p_eff[i] = 1 / (1 + odds_eff[i]); // transform odds ratio to probability
 }
}
model {
 // priors
 for (i in 1:n_s) {
  // group-level random effect (Matthijsse S. et al)
  mu[i] ~ normal(20, 2);
  // group-level average treatment effect (ATE) (Kamolratanakul S. et al)
  delta[i] ~ student_t(2, 82, 4);
  // control: binomial likelihood with logit link
  y_0[i] ~ binomial_logit(n_0[i], mu[i]);
  // vaccine: binomial likelihood with logit link
  y_1[i] ~ binomial_logit(n_1[i], mu[i] + delta[i]);
 }
}
// End file
```
```{r vaccine separate model, include = FALSE, echo = FALSE}
# initiate simulation
project_sep <- stan(file = "stan/project_sep.stan", data = data_list,
                      pars = c("p_eff", "odds_eff", "delta"))
```
The results of the model, for the probability of vaccine effectiveness, for each group $i$ are
```{r separate print, include = TRUE}
# print results
print(project_sep, pars = c("p_eff[1]", "p_eff[2]", "p_eff[3]", "p_eff[4]",
                            "p_eff[5]", "p_eff[6]", "p_eff[7]", "p_eff[8]",
                            "p_eff[9]", "p_eff[10]", "p_eff[11]"))
```
**Note: to avoid the verbose messaging from Stan's parser, I have excluded the execution code for both the separate and hierarhical model.**  

###  3.3.2 The Hierarchical model
Unlike the separate model, the hierarchical model includes a population-level average treatment effect (ATE) parameter $\psi$. Hence, unlike the previous model, here $\psi$ is drawn from a $\mathcal{N}(\mu, \sigma^{2})$ with mean $\mu$ and variance $\sigma^{2}$. Thus, the symbolic illustration of the hierarchical model differs slightly. The likelihood and priors are the same, so
\[
y_{ij} \sim Bin(n_{ij}, p_{ij})
\]
\[
logit(p_{ij}) = \mu_{i} + \Delta_{ij}
\]
where
$$
\Delta_{.j}= \begin{cases}
 0, & \text{if } j = 0 (control arm)\\
 \sim St(\nu, \psi, \tau), & \text{if } j = 1 (vaccine arm)\\
\end{cases}
$$

However, hyperiors are included to capture the expected variation of the '*population-level*' vaccine efficacy. This thus shrinks the estimate to towards a common value and, theoretically, reduces uncertainty. These hyperpriors are represented as

\[
\psi \sim \mathcal{N}(0.85, 4)
\]
and
\[
\tau \sim \mathcal{Inv-Chi}_{2}(5)
\]

The values for the population-level average treatment effect parameter $\psi$ is a sceptical prior. The intention is to pull the mean of the posterior distribution towards a more conservative estimate. Hence, the hyperprior $\psi$ takes on a mean probability of $\pi=0.7$. This translates to an odds of $\eta=\frac{\pi}{1-\pi} \approx 2.33$ and a log-odds of $ln(eta)\approx 0.85$. The degrees of freedom value for the $\mathcal{Inv-Chi}_{2}$ distribution is set at $5$, giving the parameter a reasonable range to vary over for the standard deviation of the population level distribution.

The group-level mean random effect $\mu_{i}$ is set changed to an informative prior and is intended to represent the natural evasion experienced by women (see reference: Matthijsse S. et al). Hence, rather than being set to an average effect of having $0$ immunity at baseline, the point estimate for the mean of this distribution is $\zeta=0.2$. Again, to translate this value to odds $\gamma=\frac{\zeta}{1-\zeta} \approx 0.25$ and to add this as a log-odds, $ln(\gamma)\approx -1.38$. Both parameters $\psi$ and $\mu_{i}$ have a standard deviation set to a point that allows the parameter to vary over a reasonable range.

Finally, you can find the hierarchical model's Stan syntax and results below.
```
// Random Effects
// Pair-wise meta-analysis
// Binomial model, logit link
data {
 int <lower = 0> n_s;
 int <lower = 0> y_0[n_s];
 int <lower = 0> n_0[n_s];
 int <lower = 0> y_1[n_s];
 int <lower = 0> n_1[n_s];
}
parameters {
 real psi;
 real mu[n_s];
 real delta[n_s];
 real <lower = 0> tau;
}
transformed parameters {
 real p_eff;
 real odds_eff;
 // anti-logit
 odds_eff = exp(psi);         // transform log-odds ratio to odds-ratio
 p_eff = 1 / (1 + odds_eff);  // transform odds ratio to probability
}
model {
 // hyperpriors
 psi ~ normal(0.85, 1);     // populatiuon-level ATE (Kamolratanakul S. et al)
 tau ~ inv_chi_square(5);   // populatiuon-level stdev
 // priors
 for (i in 1:n_s) {
  // group-level random effect (Matthijsse S. et al)
  mu[i] ~ normal(-1.38, 0.7);
  // group-level average treatment effect (ATE)
  delta[i] ~ student_t(2, psi, tau);
  // control: binomial likelihood with logit link
  y_0[i] ~ binomial_logit(n_0[i], mu[i]);
  // vaccine: binomial likelihood with logit link
  y_1[i] ~ binomial_logit(n_1[i], mu[i] + delta[i]);
 }
}
// End file
```
```{r vaccine hierarchical model, include = FALSE, echo = FALSE}
# initiate simulation
project_hrchl <- stan(file = "stan/project_hrchl.stan", data = data_list,
                      pars = c("p_eff", "odds_eff", "psi", "tau"))
```
```{r hierarchical print, include = TRUE}
# print results
project_hrchl
```

#  4 Inspecting the models
The following section investigates the internal validity of both the separate model by implementing leave-one-out cross-validation using the `loo` package.


#  5. Discussion

#  6. Conclusion
